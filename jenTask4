pipeline{
    agent any
    environment{
        IMAGE_NAME ="my-nginx-app"
        IMAGE_TAG ="latest"
    }
    stages{
        stage('Create Dockerfile'){
            steps{
                script{
                    writeFile file: 'Dockerfile', text:'''
                        FROM ubuntu:22.04
                        RUN apt-get update && \
                            apt-get install -y nginx && \
                            apt-get clean && \
                            rm -rf /var/lib/apt/lists/*
                        EXPOSE 80
                        CMD ["nginx", "-g", "daemon off;"]
                    '''
                }
            }
        }
        stage('Build Docker Image'){
            steps{
                script{
                    sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
                }
            }
        }
        stage('Run Docker'){
            steps{
                script{
                    sh "docker run -d --name nginx-container ${IMAGE_NAME}:${IMAGE_TAG}"
                }
            }
        }
    }
    post{
        always{
            script{
                sh "docker stop nginx-container || true"
                sh "docker rm nginx-container || true"
            }
        }
        success{
            echo "docker image successfull"
        }
        failure{
            echo "execution failure"
        }
    }
}
